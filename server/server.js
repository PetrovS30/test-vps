const express = require('express');
const cors = require('cors');
const mysql = require('mysql2/promise'); // <-- Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ mysql2/promise

const app = express();
const PORT = process.env.PORT || 5000;

app.use(cors());
app.use(express.json());

// --- ÐÐÐ§ÐÐ›Ðž: Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MySQL ---
let dbConnection; // ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ñ Ð±Ð°Ð·Ð¾Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ñ… MySQL

async function connectToDatabase() {
  try {
    // ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº Ð²Ð°ÑˆÐµÐ¹ Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… MySQL
    dbConnection = await mysql.createConnection({
      host: 'localhost',      // MySQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ñ‚Ð¾Ð¼ Ð¶Ðµ ÑÐµÑ€Ð²ÐµÑ€Ðµ
      user: 'Serg',           // Ð’Ð°Ñˆ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ MySQL
      password: 'Pa$$w0rd_MySql2025!', // Ð’Ð°Ñˆ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Serg PhpM@dm1n$Pass_2025
      database: 'test'        // Ð’Ð°ÑˆÐ° Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
    });
    console.log('âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… MySQL!');
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error.message);
    // Ð’Ð°Ð¶Ð½Ð¾: ÐµÑÐ»Ð¸ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº Ð‘Ð”, ÑÐµÑ€Ð²ÐµÑ€, Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾, Ð½Ðµ ÑÐ¼Ð¾Ð¶ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ.
    // Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð·Ð´ÐµÑÑŒ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ, Ð·Ð°Ð²ÐµÑ€ÑˆÐ°Ñ‚ÑŒ Ð»Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ.
    // Ð”Ð»Ñ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ñ‹Ñ… Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°Ñ‚ÑŒ: process.exit(1);
  }
}
// --- ÐšÐžÐÐ•Ð¦: Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MySQL ---


app.get('/api/fruit', (req, res) => {
  res.json([
    {id : 1, fruit: 'banana'},
    {id : 2, fruit: 'strawberry'},
    {id : 3, fruit: 'apricot'},
    {id : 4, fruit: 'apple'},
  ]);
});

// Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”.
app.get('/api/vegetables', async (req, res) => {
  if (!dbConnection) {
    return res.status(500).json({ error: 'Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ Ð±Ð°Ð·Ð¾Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾.' });
  }
  try {
    const [rows] = await dbConnection.execute('SELECT * FROM vegetables');
    res.json(rows);
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· Ð‘Ð”:', error.message);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ….' });
  }
});


app.listen(PORT, async () => { 
  await connectToDatabase(); 
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Express Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});

