const express = require('express');
const cors = require('cors');
const mysql = require('mysql2/promise'); // <-- –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç mysql2/promise

const app = express();

const PORT = process.env.PORT || 5000;

app.use(cors());
app.use(express.json());

// --- –ù–ê–ß–ê–õ–û: –õ–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL ---
let dbConnection; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö MySQL

async function connectToDatabase() {
  try {
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö MySQL
    dbConnection = await mysql.createConnection({
      host: 'localhost',      // MySQL –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ
      user: 'Serg',           // –í–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å MySQL
      password: 'Pa$$w0rd_MySql2025!', // –í–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Serg
      database: 'test'        // –í–∞—à–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    });
    console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö MySQL!');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:', error.message);
    // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î, —Å–µ—Ä–≤–µ—Ä, –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
    // –í—ã –º–æ–∂–µ—Ç–µ –∑–¥–µ—Å—å —Ä–µ—à–∏—Ç—å, –∑–∞–≤–µ—Ä—à–∞—Ç—å –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É.
    // –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–∞—Ç—å: process.exit(1);
  }
}
// --- –ö–û–ù–ï–¶: –õ–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL ---


// –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—Ä—É–∫—Ç–æ–≤
app.get('/api/fruit', (req, res) => {
  res.json([
    {id : 1, fruit: 'banana'},
    {id : 2, fruit: 'strawberry'},
    {id : 3, fruit: 'apricot'},
    {id : 4, fruit: 'apple'},
  ]);
});

// --- –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–∏–º–µ—Ä —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MySQL ---
// –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î.
// –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ 'example_table' –≤ –±–∞–∑–µ 'test'.
app.get('/api/vegetables', async (req, res) => {
  if (!dbConnection) {
    return res.status(500).json({ error: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.' });
  }
  try {
    // –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç—É —Ç–∞–±–ª–∏—Ü—É, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Å–æ–∑–¥–∞–¥–∏—Ç–µ –≤ phpMyAdmin.
    const [rows] = await dbConnection.execute('SELECT * FROM vegetables');
    res.json(rows);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î:', error.message);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.' });
  }
});
// --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ù–û–ì–û –≠–ù–î–ü–û–ò–ù–¢–ê ---


// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ Express
app.listen(PORT, async () => { 
  await connectToDatabase(); 
  console.log(`üöÄ –°–µ—Ä–≤–µ—Ä Express –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:${PORT}`);
  console.log(`‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: http://87.228.100.172/api/fruit`);
  console.log(`‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã): http://87.228.100.172/api/data-from-db`);
});